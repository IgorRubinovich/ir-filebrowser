<!--
@license
Copyright (c) 2015 Igor Rubinovich. All rights reserved.
This code may only be used under the MIT license found at http://opensource.org/licenses/MIT
File browser and uploader. 
Works with arrays of (node fs.Stats)[https://nodejs.org/api/fs.html#fs_class_fs_stats] objects.
Example:
<ir-file-browser>DEMO HERE</ir-file-browser>
@demo
-->

<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-input/iron-input.html">	
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../file-upload/file-upload.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-ripple/paper-ripple.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../ir-reflect-to-native-behavior/ir-reflect-to-native-behavior.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-input/paper-input.html">



<!-- link rel="import" href="../fu-area/fu-area.html" -->
<!-- link rel="import" href="./iron-select-item.html" -->

<dom-module id="ir-filebrowser">
  <style>
    :host {	
    }
    @media (max-width: 600px) {
      h1.paper-font-display1 {
        font-size: 24px;
      }
    }
	
	#selectionPreview
	{
      display: flex;
	  align-items : flex-end;
	  flex-wrap : wrap;
	}

	#scrollableDialog
	{
		min-width : 400px;
		min-height: 400px;
	}
	
	.browserDialog {

    }

	file-upload {
		--button-content-align : left;
	}
	
	#uploaderContainer {
		text-align : left;
	}
	
	#browseButton {
	}
  </style>
  <template>
	<!-- template is="dom-repeat" items="{{selected}}">
		<ir-filebrowser-item on-item-click="showDialog" on-item-dblclick="unselectFile" index="{{ index }}" item="{{ item }}"></ir-filebrowser-item>
	</template -->

	<div id="selectionPreview" hidden$="{{ promptMode }}">
		<content select="ir-filebrowser-item">
		</content>
		<template is="dom-if" if="{{value}}">
			<paper-button id="clearSelection" raised on-click="clearSelection">Clear</paper-button>
		</template>
		<paper-button id="browseButton" raised on-click="showDialog">Browse...</paper-button>
	</div>
 
	<paper-dialog on-dom-changed="refitDialog" id="dialog"> <!--  on-iron-overlay-closed="closed" -->
		<paper-tabs selected="{{tableselected}}" on-click="refitDialog">
			<paper-tab>FOLDERS</paper-tab>
			<paper-tab>SEARCH</paper-tab>
		</paper-tabs>

		<iron-pages selected="{{tableselected}}">
			<div>
				<div>
					<h2>{{ relPath }}</h2>
					<paper-checkbox checked="{{ showDirectories }}">show directories</paper-checkbox>
					<paper-checkbox checked="{{ showFiles }}">show files</paper-checkbox>
					<!--<paper-button raised on-click="refitDialog">refitDialog</paper-button>-->
					<paper-button raised on-click="makeDir">add directory</paper-button>
					<paper-button raised toggles on-click="renameFile">rename file</paper-button>
				</div>
				<paper-dialog-scrollable id="scrollableDialog">
					<file-upload id="fileUploader" fields="{{ postFields }}" on-success="ls" target="{{ _postUrl }}" noink multi>
						<div id="uploaderContainer">
							<template is="dom-if" if="{{showDirectories}}">
								<template is="dom-repeat" items="{{directories}}">
									<ir-filebrowser-item
											on-item-dblclick="dblclickDirectory"
											index="{{ index }}"
											item="{{ item }}">
									</ir-filebrowser-item>
								</template>
							</template>
							<template is="dom-if" if="{{showFiles}}">
								<template is="dom-repeat" items="{{files}}">
									<ir-filebrowser-item
											on-item-dblclick="dblclickFile"
											on-item-click="clickFile"
											index="{{ index }}"
											item="{{ item }}">
									</ir-filebrowser-item>
								</template>
							</template>
						</div>
					</file-upload>
				</paper-dialog-scrollable>
				<div class="buttons">
					Drag and drop files into this dialog to upload to the current directory.
					<template is="dom-if" if="{{promptMode}}">
						<paper-button raised on-click="hideDialog">Cancel</paper-button>
						<paper-button raised on-click="promptSelect">Select</paper-button>
					</template>
					<template is="dom-if" if="{{!promptMode}}">
						<paper-button raised on-click="hideDialog">Close</paper-button>
					</template>
				</div>
			</div>
			<div>
				<div>
					<h2>{{ relPath }}</h2>
					<paper-input placeholder="Search..." value="{{inputValue}}"></paper-input>
					<paper-button raised on-click="findFile">Search</paper-button>
				</div>
				<paper-dialog-scrollable id="scrollableDialog">
					<div id="uploaderContainer">
						<template is="dom-repeat" items="{{findedList}}">
							<div><span on-click="jumptofilePath">{{item.path}}</span></div>
						</template>
					</div>
				</paper-dialog-scrollable>
				<div class="buttons">
					<template is="dom-if" if="{{!promptMode}}">
						<paper-button raised on-click="hideDialog">Close</paper-button>
					</template>
				</div>
			</div>
		</iron-pages>
	</paper-dialog>
	<iron-ajax
		id="loader"
		method="GET"
		handle-as="json"
		debounce-duration="300"
		last-response="{{ loadedData }}"
		on-response="displayLoadedFiles"
		last-error="{{ lastError }}"
		verbose=true
		>
	</iron-ajax>

	<iron-ajax
		id="makedirloader"
		method="POST"
		handle-as="json"
		debounce-duration="300"
		on-response="updateVal"
		last-error="{{ lastError }}"
		verbose=true
		>
	</iron-ajax>

	<iron-ajax
		id="findfileloader"
		method="GET"
		handle-as="json"
		debounce-duration="300"
		last-response="{{ findedFile }}"
		on-response="showfindedFiles"
		last-error="{{ lastError }}"
		verbose=true
		>
	</iron-ajax>

	<iron-ajax
		id="renamefileloader"
		method="POST"
		handle-as="json"
		debounce-duration="300"
		on-response="updateVal"
		last-error="{{ lastError }}"
		verbose=true
		>
	</iron-ajax>


  </template>
</dom-module>

<dom-module id="ir-filebrowser-item">
  <style>
	:host
	{
		width  : 150px;
		display : inline-block;
		overflow : hidden;
		text-align : center;
		padding : 0;
	}
	iron-image {
		width : 150px;
		height : 150px;
		background: white;
		background-size : 32px;
	}
	paper-material {	
		overflow : hidden;
		margin : 2px;
		transition : .3s;
	}
	.ext {
		text-transform : none;
		cursor : pointer;
		-webkit-user-select: none;
		user-select: none;
		font-size : 1.5em;
		line-height : 3em;
		text-align : center;
		display : block;
		height : 150px;
		color : #aaa;
		background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAMAAAC67D+PAAAAElBMVEX////v7+/v7+/v7+/v7+/v7+9mq1VzAAAABnRSTlMAPFTN4++SiZA2AAAAGUlEQVR4AWOAAUZWBIsZzmKiAouBhRnGAgARGwBPNJN0/gAAAABJRU5ErkJggg==);
		background-repeat : no-repeat;
		/* background-color : #efefef; */
		border-top-left-radius : 5px;
	}
	span {
		white-space : nowrap;
	}
	.selected {
		/*opacity : .5;
		background : #fafafa;
		box-shadow : 0px 0px 4px black inset;*/
		transform : translate(1px, 1px);
	}
  </style>
  <template>
		<paper-material elevation="2" id="container" on-click="click" on-dblclick="dblclick">
			<paper-ripple></paper-ripple>
			<template is="dom-if" if="{{_item.isImage}}">
				<iron-image title="{{_item.url}}" preload fade id="imgthumb" sizing="contain" src="{{_item.url}}"></iron-image>
			</template>
			<template is="dom-if" if="{{!_item.isImage}}">
				<span class="ext">{{ _item.ext }}</span>
			</template>
			<span title="{{_item.name}}">{{_item.name}}</span>
		</paper-material>

  </template>
</dom-module>


<script src="ir-filebrowser.js"></script>
