<!--
@license
Copyright (c) 2015 Igor Rubinovich. All rights reserved.
This code may only be used under the MIT license found at http://opensource.org/licenses/MIT
File browser and uploader. 
Works with arrays of (node fs.Stats)[https://nodejs.org/api/fs.html#fs_class_fs_stats] objects.
Example:
<ir-file-browser>DEMO HERE</ir-file-browser>
@demo
-->

<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-input/iron-input.html">	
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../file-upload/file-upload.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-ripple/paper-ripple.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../ir-reflect-to-native-behavior/ir-reflect-to-native-behavior.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../iron-dropdown/iron-dropdown.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-item/paper-item-body.html">
<link rel="import" href="../paper-spinner/paper-spinner.html">
<link rel="import" href="../paper-radio-button/paper-radio-button.html">
<link rel="import" href="../paper-radio-group/paper-radio-group.html">
<link rel="import" href="../Sortable/Sortable.html">



<!-- link rel="import" href="../fu-area/fu-area.html" -->
<!-- link rel="import" href="./iron-select-item.html" -->

<dom-module id="ir-filebrowser">
  <style>
    :host {	
    	
    }
    @media (max-width: 600px) {
      h1.paper-font-display1 {
        font-size: 24px;
      }
    }
	
	#selectionPreview
	{
      display: flex;
	  align-items : flex-end;
	  flex-wrap : wrap;
	}

	#scrollableDialog
	{
		min-width : 400px;
		min-height: 400px;
	}
	
   	#dialog {
		padding : 10px;
	    width: auto!important;
	    left: 0!important;
	    right: 0!important;
	    bottom: 0!important;
	    top: 0!important;
	    position: fixed!important;
	}

	:host[full-view] #dialog {
		padding : 10px;
	    width: auto!important;
	    left: 0!important;
	    right: 0!important;
	    bottom: 0!important;
	    top: 0!important;
	    position: absolute!important;
	}
	
	file-upload {
		--button-content-align : left;
	}
	
	#uploaderContainer {
		text-align : left;
		min-heght : 400px;
		width : 100%;
	}

	#searchBox {
		display : flex;
		flex-direction : row;
	}
	
	#searchButton {
		margin-top: 22px;
		padding-top: 13px;
		bottom: 12px;
	}
	
	#relPath {
		top: 10px;
		position: relative;
		margin-right : 10px;
	}

	#drawPocket {
		border-left: 1px solid #e5e5e5;
		border-bottom: 1px solid #e5e5e5;
		padding: 5px;
		overflow-x : hidden;
	}

	#scrollableFiles {
		overflow: auto;
	}

	iron-image {
		width : 150px;
		height : 150px;
		background: white;
		background-size : 32px;
	}
	
	.buttons {
		display: flex;
		align-items : center;
		justify-content : space-between;
	}

	#bottomButtons file-upload {
		overflow : hidden;
	}
	
	#bottomButtons {
		display : flex;
		justify-content : space-between;
		margin-top : 5px;
	}
	
	#fileUploaderContainer {
		margin-bottom : 5px;
		max-height : 60px;
		overflow : hidden;
		display : flex;
		--upload-border-style : {
			display : flex;
			flex-direction : row;
			padding : 0;
			margin : 0;
		};
	}

	#selectionUploader {
		max-height : 40px;
	}

	#selectionUploader paper-button {
		padding: 0;
		margin: 0;
		box-shadow: none;
	}
	
	#imgpreview {
		float : right;
		width : 50%;
	}

	.topNavButtons {
		margin-top: 20px;
	}
	
	.clearfloat
	{
		clear : both;
	}
	
	#fileInfo label{
		margin-top: 5px;
		font-size: smaller;
		display: block;
		color: grey;
	}

	.desiredImg {
	    border-collapse: collapse;
	    border-radius: 24px;
	    border-width: 24px;
	    height: 44px;
	    width: 44px;
	}

	#searchInput {
		width : 300px;
	}

	#selectionNav {
		display : flex;
	}

	@media (max-width: 600px) {
      #uploaderContainer {
        width: 300px;
      }
      #scrollableDialog {
      	min-width: 300px;
      }
      #dialog {
      	margin: 0;
      }
      #topNav {
      	flex-direction: column;
      }
      #searchInput {
      	width : 250px;
      }
      #filesNav {
      	align-items : baseline;
      	flex-direction: column;
      }
      #galleryCheckbox {
      	padding: 0;
      }
      #homeButton{
      	position: absolute;
      }
      .topNavButtons {
      	margin-top: 15px;
      }
      .buttons {
      	padding: 0;
      }

    }

  </style>
  <template>
	<!-- template is="dom-repeat" items="{{selected}}">
		<ir-filebrowser-item on-item-click="showDialog" on-item-dblclick="unselectFile" index="{{ index }}" item="{{ item }}"></ir-filebrowser-item>
	</template -->

	<iron-media-query query="(max-width: 600px)" query-matches="{{ mobile }}"></iron-media-query>

	<div hidden$="{{ archiveMode }}">
		<div id="selectionPreview" hidden$="{{ promptMode }}">
			<div>
				<sortable-js id="sortableContent" handle="ir-filebrowser-item" on-update="updatefbValue">
					<content select="ir-filebrowser-item">
					</content>
				<sortable-js>
			</div>

			<div id="selectionNav">
				<template is="dom-if" if="{{value}}">
					<paper-button id="clearSelection" raised on-click="clearSelection">Clear all</paper-button>
				</template>
				<paper-button id="browseButton" raised on-click="showDialog">My files</paper-button>
				<div id="selectionUploader">
					<file-upload id="selectionFileUploader" fields="{{ postFields }}" target="{{ _postUrl }}" noink multi progress-timeout="0" hidden$="[[ isUploadingFiles ]]">
							<div hidden$="[[ isUploadingFiles ]]">
								<paper-button raised>Browse...</paper-button>
							</div>
					</file-upload>
				</div>
			</div>
		</div>
	</div>

	<paper-dialog no-cancel-on-esc-key="[[ fullView ]]" no-cancel-on-outside-click="[[ fullView ]]" on-keydown="blockBackspace" opened$="{{ opened }}" id="dialog"> <!--  on-iron-overlay-closed="closed" -->
		<div id="topTabs">
			<paper-tabs selected="{{tableselected}}" on-click="refitDialog">
				<paper-tab>FOLDERS</paper-tab>
				<paper-tab>SEARCH</paper-tab>
			</paper-tabs>

			<iron-pages selected="{{tableselected}}">
				<div class="layout vertical left">
					<div id="topNav" class="layout horizontal center">
							<div id="homeButton" style="padding-right: 10px;">
								<paper-icon-button class="topNavButtons" icon="home" on-tap="goHome"></paper-icon-button>
							</div>
							<h3 id="relPath">
								<template is="dom-repeat" items="{{ splitRelPath }}">
									<a href="javascript:void(0)" on-click="jumpUp"><span>{{ item }}</span>/</a> 
								</template>
							</h3>
							<paper-input placeholder="Filter..." value="{{filterValue}}" on-keyUp="displayLoadedFiles" hidden$="{{ mobile }}">
							</paper-input>
							<paper-icon-button class="topNavButtons" icon="clear" on-tap="filterClear" hidden$="{{ mobile }}">
							</paper-icon-button>
						<div class="layout horizontal center" style="margin-left:30px">
							<paper-input id="searchInput" placeholder="Search by description..." value="{{searchValue}}" on-keyup="searchFiles">
							</paper-input>
							<paper-icon-button class="topNavButtons" icon="clear" on-tap="searchClear">
							</paper-icon-button>
						</div>		
					</div>
					<div>
						<paper-icon-button icon="menu" on-click="triggerMenu" hidden$="{{ !mobile }}"></paper-icon-button>
						<paper-checkbox checked="{{ showInfo }}" hidden$="{{ !mobile }}">show file info</paper-checkbox>
					</div>
					<div id="filesNav" class="layout horizontal center" hidden$="{{ mobile }}">
						<paper-item>
							<paper-checkbox checked="{{ showDirectories }}">show directories</paper-checkbox>
						</paper-item>
						<paper-item>
							<paper-checkbox checked="{{ showFiles }}">show files</paper-checkbox>
						</paper-item>
						<paper-item>
							<paper-checkbox checked="{{ postFields.resize }}">resize</paper-checkbox>
						</paper-item>
						<!--<paper-button raised on-click="refitDialog">refitDialog</paper-button>-->
						<div>
							<paper-button hidden$="{{ !_makedirUrl }}" raised on-click="makeDir">add dir</paper-button>
							<paper-button hidden$="{{ !_renameUrl }}" raised$="{{ !renameFiles }}" on-click="renameFile">rename</paper-button>
							<paper-button hidden$="{{ !_deletefileUrl }}" raised on-click="deleteFile">delete</paper-button>
						</div>
					</div>
				</div>
			</iron-pages>
		</div>
		<paper-dialog-scrollable id="scrollableDialog">
			<paper-drawer-panel id="pocketDrawer" right-drawer>
				<div id="drawPocket" drawer>
					<p hidden$="{{ !noFile }}">File info will appear here</p>
					<div id="fileInfo" hidden$="{{ noFile }}">
						<div hidden$="{{ !archiveMode }}">
							<a href="{{ linkForDownload }}" download><iron-icon icon="file-download">
							</iron-icon>download</a>
							<h3>{{ meta.caption }}</h3>
							<p>{{ meta.description }}</p>
						</div>
						<div>{{ fName }}</div>
						<div id="imgpreview" hidden$="{{ noImage }}">
							<iron-image title="{{ fUrl }}" preload fade sizing="contain" src="{{ fUrl }}"></iron-image>
						</div>
						<label>Size</label><div>{{ fSize }}</div>
						<label>Date</label><div>{{ fDate }}</div>
						<span hidden$="{{ noImage }}"><label>Image Dimensions</label><div><span>{{ meta.width }}</span> x <span>{{ meta.height }}</span></div></span>
						<div class="clearfloat"></div>
						<div hidden$="{{ archiveMode }}">
							<div hidden$="{{ hasInfo }}">No information</div>
							<div hidden$="{{ !hasInfo }}">
								<paper-input label="Title" value="{{ meta.title }}" on-change="updateDescription" disabled="{{ archiveMode }}"></paper-input>
								<paper-input on-keyup="metaChanged" label="Caption" value="{{ meta.caption }}" on-change="updateDescription" disabled="{{ archiveMode }}"></paper-input>
								<paper-input label="Description" value="{{ meta.description }}" on-change="updateDescription" disabled="{{ archiveMode }}"></paper-input>
								<paper-input label="Alt" value="{{ meta.alt }}" on-change="updateDescription" disabled="{{ archiveMode }}"></paper-input>
							</div>		
						</div>					
					</div>
				</div>
				<iron-pages selected="{{tableselected}}" id="scrollableFiles" on-scroll="loadMoreFiles" main>
					<div>
						<div id="uploaderContainer">	
							<span hidden$="{{ !showDirectories }}">
								<template hidden$="{{ showDirectories }}" is="dom-repeat" items="{{directories}}">
									<ir-filebrowser-item
											on-item-dblclick="dblclickDirectory"
											on-item-click="clickFile"
											index="{{ index }}"
											item="{{ item }}">
									</ir-filebrowser-item>
								</template>
							</span>
							<span id="fileItemsList" hidden$="{{ !showFiles }}">
								<template hidden$="{{showFiles}}" id="fileItems" is="dom-repeat" items="{{files}}">
									<ir-filebrowser-item
											on-item-dblclick="dblclickFile"
											on-item-click="clickFile"
											index="{{ index }}"
											item="{{ item }}">
									</ir-filebrowser-item>
								</template>
							</span>
						</div>
					</div>
					<div>
						<div class="layout horizontal">
							<paper-input placeholder="Search..." value="{{inputValue}}" on-keyDown="searchBoxKeyDown" ></paper-input>
							<paper-button raised id="searchButton" on-click="findFile">Search</paper-button>
						</div>
						<div>
							<template is="dom-repeat" items="{{foundList}}">
								<paper-item elevation="1" on-tap="jumptofilePath">{{item.path}}</paper-item>
							</template>
						</div>
					</div>
				</iron-pages>
			</paper-drawer-panel>
		</paper-dialog-scrollable>

		<div id="bottomButtons" class="buttons" hidden$="{{ archiveMode }}">
			<div id="fileUploaderContainer">
				<span hidden$="{{ mobile }}">
					<paper-spinner class="loaded" active$="[[ isLoaded ]]"></paper-spinner>
				</span>
				<span hidden$="{{ mobile }}">
					<paper-spinner class="loaded" active$="[[ isUploadingFiles ]]"></paper-spinner>
				</span>
				<span hidden$="[[ !isUploadingFiles ]]">
					<span hidden$="{{ mobile }}">Files left: </span><span hidden$="{{ mobile }}">{{ uploadedFiles }}</span>
				</span>
				<file-upload id="fileUploader" on-files-changed="filesChanged" fields="{{ postFields }}" on-success="makeList" target="{{ _postUrl }}" noink multi progress-timeout="0" hidden$="[[ isUploadingFiles ]]">
					<div hidden$="[[ isUploadingFiles ]]">
						<paper-button raised>Browse...</paper-button> <span hidden$="{{ mobile }}">or drop files into this dialog</span>
					</div>
				</file-upload>
			</div>
			<div class="buttons">
				<div hidden$="{{ fullViewMode }}">
				<span class="layout horizontal" hidden$="{{ !promptMode }}">
					<paper-item id="galleryCheckbox">
						<paper-checkbox title="if You want to combine pictures in the gallery click on this checkbox" checked="{{ gallery }}"><span hidden$="{{ mobile }}">Gallery</span></paper-checkbox>
					</paper-item>
					<paper-button raised on-click="hideDialog">Cancel</paper-button>
					<paper-button raised on-click="promptSelect">Select</paper-button>
				</span>
				<paper-button hidden$="{{ promptMode }}" raised on-click="hideDialog">Close</paper-button>
				</div>
			</div>
		</div>
	</paper-dialog>
	<iron-ajax
		id="loader"
		method="GET"
		handle-as="json"
		debounce-duration="300"
		last-response="{{ loadedData }}"
		on-response="displayLoadedFiles"
		last-error="{{ lastError }}"
		verbose=true
		>
	</iron-ajax>

	<iron-ajax
		id="makedirloader"
		method="POST"
		handle-as="json"
		debounce-duration="300"
		on-response="updateVal"
		last-error="{{ lastError }}"
		verbose=true
		>
	</iron-ajax>

	<iron-ajax
		id="findfileloader"
		method="GET"
		handle-as="json"
		debounce-duration="300"
		last-response="{{ foundFile }}"
		on-response="showfoundFiles"
		last-error="{{ lastError }}"
		verbose=true
		>
	</iron-ajax>

	<iron-ajax
		id="renamefileloader"
		method="POST"
		handle-as="json"
		debounce-duration="300"
		last-response="{{ renamedFile }}"
		on-response="renameSelectionElement"
		last-error="{{ lastError }}"
		verbose=true
		>
	</iron-ajax>

	<iron-ajax
		id="deletefileloader"
		method="POST"
		handle-as="json"
		debounce-duration="300"
		last-response="{{ deletedFile }}"
		on-response="deleteSelectionElement"
		on-error="cannotDelete"
		last-error="{{ deleteFileError }}"
		verbose=true
		>
	</iron-ajax>

	<iron-ajax
		id="getDescription"
		method="GET"
		handle-as="json"
		debounce-duration="300"
		last-response="{{ fileDescription }}"
		on-response="showDescription"
		verbose="true">
	</iron-ajax>

	<iron-ajax
		id="updateFile"
		method="POST"
		handle-as="json"
		debounce-duration="300"
		verbose="true">
	</iron-ajax>

	<iron-ajax
		id="searchByDesc"
		method="GET"
		handle-as="json"
		debounce-duration="300"
		last-response="{{ desiredFiles }}"
		on-response="listDesire"
		on-error="nothingFound"
		verbose="true">
	</iron-ajax>	

  </template>
</dom-module>

<dom-module id="ir-filebrowser-item">
  <style>
	:host
	{
		width  : 180px;
		display : inline-block;
		overflow : hidden;
		text-align : center;
		padding : 0;
	}

	iron-image {
		width : 180px;
		height : 140px;
		background: white;
		background-size : 32px;
	}
	paper-material {	
		overflow : hidden;
		margin : 3px;
		transition : .2s;
	}
	.ext {
		text-transform : none;
		cursor : pointer;
		-webkit-user-select: none;
		user-select: none;
		font-size : 1.5em;
		line-height : 3em;
		text-align : center;
		display : block;
		height : 150px;
		color : #aaa;
		background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAMAAAC67D+PAAAAElBMVEX////v7+/v7+/v7+/v7+/v7+9mq1VzAAAABnRSTlMAPFTN4++SiZA2AAAAGUlEQVR4AWOAAUZWBIsZzmKiAouBhRnGAgARGwBPNJN0/gAAAABJRU5ErkJggg==);
		background-repeat : no-repeat;
		/* background-color : #efefef; */
		border-top-left-radius : 5px;
	}
	@media (max-width: 600px) {
	  :host
	  {
	  	width: 90px;
	  }	
      iron-image 
      {
        width: 90px;
        height: 60px;
      }
      .ext
      {
      	height: 60px;
      }
    }
	span {
		white-space : nowrap;
	}

  </style>
  <template>

	  <paper-material elevation="0" id="container" on-click="click" on-dblclick="dblclick">
		  <paper-ripple></paper-ripple>
		  <template is="dom-if" if="{{_item.isImage}}">
			  <iron-image title="{{_item.url}}" preload fade id="imgthumb" sizing="contain" src="{{_item.url}}"></iron-image>
		  </template>
		  <template is="dom-if" if="{{!_item.isImage}}">
			  <span class="ext">{{ _item.ext }}</span>
		  </template>
		  <span title="{{_item.name}}">{{_item.name}}
		  	<template is="dom-if" if="{{ isSelectionItem }}">
	  			<iron-icon icon="delete"></iron-icon>
	  		</template>
		  </span>
	  </paper-material>

	  <template is="dom-if" if="{{ isSelectionItem }}">
	  		<paper-radio-button name$="{{ _item.name }}" active on-click="fireUpdate">Make this image a cover</paper-radio-button>
	  </template>
  </template>
</dom-module>


<script src="ir-filebrowser.js"></script>
